{{ define "main" }}
<main class="main">
    <div class="post-content">
        <div id="graph-container" style="width: 100%; height: 80vh;"></div>
    </div>
</main>

<script src="https://cdn.jsdelivr.net/npm/echarts@5.3.3/dist/echarts.min.js"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        var chart = echarts.init(document.getElementById('graph-container'));

        var nodes = [
            {{- range $index, $page := .Site.RegularPages -}}
            {{- if and (ne $page.Type "graph") (not .Params.private) -}}            {
                id: {{ $page.Title | jsonify }},
                name: {{ $page.Title | jsonify }},
                symbolSize: 10,
                value: "{{ $page.RelPermalink }}",
                category: {{ with $page.Params.categories }}{{ index $page.Params.categories 0 | jsonify }}{{ else }}null{{ end }}
            },
            {{- end -}}
            {{- end -}}
        ];

        var links = [
            {{- range $page := .Site.RegularPages -}}
            {{- if and (ne $page.Type "graph") (not .Params.private) -}}
            {{- if $page.Params.links -}}
            {{- range $link_title := $page.Params.links -}}
            {{- $targetPage := where $.Site.RegularPages "Title" $link_title | first -}}
            {{- if $targetPage -}}
            {
                source: {{ $page.Title | jsonify }},
                target: {{ $targetPage.Title | jsonify }}
            },
            {{- end -}}
            {{- end -}}
            {{- end -}}
            {{- end -}}
            {{- end -}}
        ];
        
        var categories = [
            {{- range $name, $taxonomy := .Site.Taxonomies.categories -}}
            { name: {{ $name | jsonify }} },
            {{- end -}}
        ];

        var option = {
            title: {
                text: '知识网络图谱',
                top: 'bottom',
                left: 'right'
            },
            tooltip: {
                formatter: function (params) {
                    if (params.dataType === 'node') {
                        return params.name;
                    }
                }
            },
            legend: [{
                data: categories.map(function (a) {
                    return a.name;
                })
            }],
            animationDuration: 1500,
            animationEasingUpdate: 'quinticInOut',
            series: [
                {
                    type: 'graph',
                    layout: 'force',
                    data: nodes,
                    links: links,
                    categories: categories,
                    roam: true,
                    label: {
                        show: true,
                        position: 'right',
                        formatter: '{b}'
                    },
                    lineStyle: {
                        color: 'source',
                        curveness: 0.3
                    },
                    emphasis: {
                        focus: 'adjacency',
                        lineStyle: {
                            width: 10
                        }
                    },
                    force: {
                        repulsion: 100
                    }
                }
            ]
        };

        chart.setOption(option);

        chart.on('click', function (params) {
            if (params.dataType === 'node' && params.value) {
                window.open(params.value, '_self');
            }
        });
    });
</script>
{{ end }}
